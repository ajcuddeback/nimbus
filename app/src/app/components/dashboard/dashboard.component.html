@if (!isBrowser) {
  <ng-container *ngTemplateOutlet="loading" />
} @else {
  @if (weatherData$ | async; as weatherData; ) {
    @if (weatherData.current.state === 'loading' || weatherData.summary.state === 'loading' || weatherData.today.state === 'loading') {
      <ng-container *ngTemplateOutlet="loading" />
    } @else if (weatherData.current.state === 'error' || weatherData.summary.state === 'error' || weatherData.today.state === 'error') {
      <p>Failed</p>
    } @else {
      <p-card header="AI Summary">
        <p>{{ weatherData.summary.data.summary }}</p>
      </p-card>
      @let latestWeatherData = weatherData.current.data[weatherData.current.data.length - 1];
      @let currentWeatherData = weatherData.current.data;
      @let todaysWeatherData = weatherData.today.data;
      <p-card header="Temp">
        Current: {{ formattedTemp }}
        <br/>
        Feels
        Like: {{ formatTemp(calculateFeelsLikeTemp(latestWeatherData.temp, latestWeatherData.hum, latestWeatherData.windSpeed)) }}
        <app-temp-line [tempData]="gatherTemps(currentWeatherData)" [timestamps]="gatherTimestamps(currentWeatherData)"
                       [tempFormat]="tempFormat"/>
      </p-card>
      <p-card header="Today's Temp Variablility">
        Today's Peak Temp: {{ getPeakTemp(todaysWeatherData) }}
        <app-temp-line [tempData]="gatherTemps(todaysWeatherData)" [timestamps]="gatherTimestamps(todaysWeatherData)"
                       [tempFormat]="tempFormat"/>
      </p-card>
      <p-card header="Humidity">
        Current: {{ latestWeatherData.hum }}%
        <app-humidity-line [humidity]="gatherHumidity(currentWeatherData)"
                           [timestamps]="gatherTimestamps(currentWeatherData)"/>
      </p-card>
      <p-card header="Today's Humidity Variablility">
        Today's Peak Humidity: {{ getPeakHumidity(todaysWeatherData) }}
        <app-humidity-line [humidity]="gatherHumidity(todaysWeatherData)"
                           [timestamps]="gatherTimestamps(todaysWeatherData)"/>
      </p-card>
      <p-card header="Pressure">
        Current: {{ convertPressureToInches(latestWeatherData.pr) }} in
        <app-pressure-line [pressures]="gatherPressures(currentWeatherData)"
                           [timestamps]="gatherTimestamps(currentWeatherData)"/>
      </p-card>
      <p-card header="Wind Speed">
        Current: {{ latestWeatherData.windSpeed }} mph
        <app-wind-line [windSpeeds]="gatherWindSpeeds(currentWeatherData)"
                       [timestamps]="gatherTimestamps(currentWeatherData)"/>
      </p-card>
      <p-card header="Today's Wind Speed Variablility">
        <app-wind-line [windSpeeds]="gatherWindSpeeds(todaysWeatherData)"
                       [timestamps]="gatherTimestamps(todaysWeatherData)"/>
      </p-card>
      <p-card header="Wind Direction">
        <app-compass [direction]="latestWeatherData.windDirection"/>
      </p-card>
      <p-card header="Rainfall Total">
        Current Total: {{ getRainTotal(currentWeatherData) }}in.
        <app-rainfall-line [rainfall]="gatherRainfall(currentWeatherData)"
                           [timestamps]="gatherTimestamps(currentWeatherData)"/>
      </p-card>
      <p-card header="Today's Rainfall Total">
        Today's Total: {{ getRainTotal(todaysWeatherData) }}in.
        <app-rainfall-line [rainfall]="gatherRainfall(todaysWeatherData)"
                           [timestamps]="gatherTimestamps(todaysWeatherData)"/>
      </p-card>

    }
  }
}

<ng-template #loading>
  <p-card header="Temp">
    <p-skeleton height="1.25rem" class="mb-2" width="6rem" />
    <p-skeleton height="1.25rem" class="mb-2" width="6rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Today's Temp Variablility">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Humidity">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Today's Humidity Variablility">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Pressure">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Wind Speed">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Today's Wind Speed Variablility">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Wind Direction">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Rainfall Total">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
  <p-card header="Today's Rainfall Total">
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="2rem" class="mb-2" width="5rem" />
    <p-skeleton height="25rem" />
  </p-card>
</ng-template>
